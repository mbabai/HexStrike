<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>HexStrike Lobby</title>
    <link rel="stylesheet" href="/theme.css" />
  </head>
  <body>
    <div class="ui-shell">
      <header class="hero-header">
        <div class="hero-header-content">
          <div class="branding">
            <p class="eyebrow">HexStrike / Live Lobby</p>
            <h1>Command Your Squad</h1>
            <p class="subtitle">Queue up, launch custom matches, and watch the event feed in a single place.</p>
          </div>
          <div class="hero-actions">
            <button id="connect" class="btn btn-primary">Connect</button>
            <div id="connectionStatus" class="status-pill">Not connected</div>
          </div>
        </div>
      </header>

      <div class="grid-layout">
        <section class="panel">
          <h2>Identity</h2>
          <p>Set your user details before connecting to the lobby stream.</p>
          <div class="field-row">
            <label> User ID <input id="userId" /> </label>
            <label> Username <input id="username" /> </label>
          </div>
          <small>Tip: IDs persist in local storage so you can hop back in with the same identity.</small>
        </section>

        <section class="panel">
          <h2>Custom Match</h2>
          <p>Challenge a specific opponent and create a direct match invitation.</p>
          <div class="field-row">
            <label> Opponent ID <input id="opponentId" /> </label>
            <label> Opponent Name <input id="opponentName" /> </label>
          </div>
          <div class="section-actions">
            <button id="customMatch" class="btn">Create Custom Match</button>
          </div>
        </section>

        <section class="panel">
          <h2>Queues</h2>
          <p>Hop into matchmaking queues using the themed quick actions.</p>
          <div class="pill-group">
            <button data-queue="quickplayQueue" class="btn btn-primary">Join Quickplay</button>
            <button data-leave="quickplayQueue" class="btn btn-ghost">Leave Quickplay</button>
            <button data-queue="rankedQueue" class="btn btn-primary">Join Ranked</button>
            <button data-leave="rankedQueue" class="btn btn-ghost">Leave Ranked</button>
            <button data-queue="botQueue" class="btn btn-primary">Join Bot Queue</button>
            <button data-leave="botQueue" class="btn btn-ghost">Leave Bot Queue</button>
          </div>
          <div class="divider"></div>
          <button id="clear" class="btn">Clear All Queues</button>
        </section>

        <section class="panel">
          <h2>Lobby Snapshot</h2>
          <p>Live state from the matchmaking service.</p>
          <pre id="lobby"></pre>
        </section>

        <section class="panel">
          <h2>Event Log</h2>
          <p>Chronological updates from the server stream.</p>
          <pre id="log"></pre>
        </section>
      </div>
    </div>

    <script>
      const logEl = document.getElementById('log');
      const lobbyEl = document.getElementById('lobby');
      const userIdInput = document.getElementById('userId');
      const usernameInput = document.getElementById('username');
      const statusEl = document.getElementById('connectionStatus');
      const opponentIdInput = document.getElementById('opponentId');
      const opponentNameInput = document.getElementById('opponentName');
      let eventSource;
      let userId = localStorage.getItem('hexstrikeUser') || crypto.randomUUID();
      userIdInput.value = userId;

      function log(message, data) {
        const line = `[${new Date().toLocaleTimeString()}] ${message}`;
        logEl.textContent = `${line}\n${data ? JSON.stringify(data, null, 2) : ''}\n\n${logEl.textContent}`;
      }

      function renderLobby(snapshot) {
        lobbyEl.textContent = JSON.stringify(snapshot, null, 2);
      }

      function connect() {
        if (eventSource) eventSource.close();
        userId = userIdInput.value || crypto.randomUUID();
        localStorage.setItem('hexstrikeUser', userId);
        const url = `/events?userId=${encodeURIComponent(userId)}`;
        eventSource = new EventSource(url);
        eventSource.onmessage = (event) => {
          const parsed = JSON.parse(event.data);
          log(parsed.type, parsed.payload);
          if (parsed.type === 'connected') {
            statusEl.textContent = `Connected as ${parsed.payload.userId}`;
            renderLobby(parsed.payload.lobby);
          }
          if (parsed.type === 'queueChanged') renderLobby(parsed.payload);
        };
        eventSource.onerror = () => {
          statusEl.textContent = 'Connection lost';
        };
      }

      async function post(path, payload) {
        const res = await fetch(path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        return res.json();
      }

      document.getElementById('connect').addEventListener('click', connect);
      document.querySelectorAll('button[data-queue]').forEach((button) => {
        button.addEventListener('click', async () => {
          const queue = button.getAttribute('data-queue');
          const response = await post('/api/v1/lobby/join', {
            userId,
            username: usernameInput.value || userId,
            queue,
          });
          renderLobby(response.lobby);
        });
      });

      document.querySelectorAll('button[data-leave]').forEach((button) => {
        button.addEventListener('click', async () => {
          const queue = button.getAttribute('data-leave');
          const response = await post('/api/v1/lobby/leave', { userId, queue });
          renderLobby(response.lobby);
        });
      });

      document.getElementById('clear').addEventListener('click', async () => {
        const snapshot = await post('/api/v1/lobby/clear', {});
        renderLobby(snapshot);
      });

      document.getElementById('customMatch').addEventListener('click', async () => {
        const response = await post('/api/v1/match/custom', {
          hostId: userId,
          hostName: usernameInput.value || userId,
          guestId: opponentIdInput.value || crypto.randomUUID(),
          guestName: opponentNameInput.value || 'Guest',
        });
        log('match created', response.match);
        log('game created', response.game);
      });

      connect();
    </script>
  </body>
</html>
